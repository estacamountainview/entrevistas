<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Entrevistas</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0CBYKBPH9F"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-0CBYKBPH9F");
    </script>

    <link rel="stylesheet" href="entrevistas.css" />
  </head>

  <body>
    <main class="page">
      <div class="container">
        <section class="card">
          <header class="header">
            <h1>Entrevistas con la Presidencia de Estaca</h1>
            <p class="sub">
              Programe su entrevista con la presidencia de estaca llenando el
              siguiente formulario. Después de enviarlo, será redirigido al
              calendario para seleccionar la fecha y hora disponibles.
            </p>
          </header>

          <form id="form" novalidate>
            <div class="row">
              <label>Nombre <span class="req">*</span></label>
              <input type="text" name="first_name" required />
            </div>

            <div class="row">
              <label>Apellido <span class="req">*</span></label>
              <input type="text" name="last_name" required />
            </div>

            <div class="row">
              <label>Correo electrónico <span class="req">*</span></label>
              <input
                type="email"
                name="email"
                placeholder="nombre@email.com"
                required
              />
            </div>

            <div class="row">
              <label>Número de teléfono <span class="req">*</span></label>
              <input
                type="tel"
                name="phone"
                placeholder="Ej. 8015551234"
                inputmode="numeric"
                pattern="[0-9]{10}"
                maxlength="10"
                required
              />
            </div>

            <div class="row">
              <label>Barrio <span class="req">*</span></label>
              <select name="barrio" required>
                <option value="">Seleccione…</option>
                <option>Vineyard 7</option>
                <option>Sharon Park 13</option>
                <option>Springwater 3</option>
                <option>Suncrest 8</option>
                <option>Lakeview 11</option>
                <option>Geneva Heights 1</option>
                <option>Cherry Hill 8</option>
                <option>Hillcrest 9</option>
              </select>
            </div>

            <div class="row">
              <label>Motivo de entrevista <span class="req">*</span></label>
              <select name="motivo" required>
                <option value="">Seleccione…</option>
                <option>Renovacion de recomendacion</option>
                <option>Ecclesiastical endorsement</option>
                <option>Futuro Misionero</option>
                <option>Primera vez entrando al templo</option>
                <option>Sellamiento</option>
                <option>Apartamiento pendiente</option>
                <option>Llamamiento / Reporte</option>
              </select>
            </div>

            <div class="row" id="llamamientoRow" style="display: none">
              <label
                >Seleccione su llamamiento <span class="req">*</span></label
              >
              <select name="llamamiento">
                <option value="">Seleccione…</option>
                <option>Presidente de quorum de elderes</option>
                <option>Presidenta de sociedad de socorro de estaca</option>
                <option>Obispo</option>
                <option>Patriarca</option>
                <option>Presidenta de Primaria de estaca</option>
                <option>Miembro del Sumo Consejo</option>
              </select>
            </div>

            <button type="submit" id="submitBtn" class="btn">Continuar</button>

            <p id="msg" class="msg" role="status" aria-live="polite"></p>
          </form>
        </section>
      </div>
    </main>

    <script>
      const URL_A =
        "https://calendly.com/estacamountainview/entrevista-con-presidencia-de-estaca";
      const URL_B =
        "https://calendly.com/marteiduel/entrevista-con-presidente-de-estaca";
      const URL_BY_MOTIVO = {
        "Renovacion de recomendacion": URL_A,
        "Ecclesiastical endorsement": URL_A,
        "Futuro Misionero": URL_B,
        "Primera vez entrando al templo": URL_B,
        Sellamiento: URL_B,
        "Apartamiento pendiente": URL_B,
        "Llamamiento / Reporte": URL_B,
      };
      const DEFAULT_URL = URL_B;

      function normalize(text) {
        return (text || "")
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function buildUrl(baseUrl, params) {
        const qs = new URLSearchParams();
        for (const key in params) {
          const value = (params[key] || "").toString().trim();
          if (value) qs.set(key, value);
        }
        return qs.toString() ? baseUrl + "?" + qs.toString() : baseUrl;
      }

      // Bloquear letras en teléfono (incluye "e")
      const phoneInput = document.querySelector('input[name="phone"]');
      phoneInput.addEventListener("input", () => {
        phoneInput.value = phoneInput.value.replace(/[^0-9]/g, "");
      });

      const form = document.getElementById("form");
      const msg = document.getElementById("msg");
      const btn = document.getElementById("submitBtn");
      const llamamientoRow = document.getElementById("llamamientoRow");
      const motivoSelect = document.querySelector('select[name="motivo"]');
      const llamamientoSelect = document.querySelector(
        'select[name="llamamiento"]',
      );

      function toggleLlamamiento() {
        const show =
          normalize(motivoSelect.value) === normalize("Llamamiento / Reporte");
        llamamientoRow.style.display = show ? "block" : "none";
        llamamientoSelect.required = show;
        if (!show) {
          llamamientoSelect.value = "";
        }
      }

      motivoSelect.addEventListener("change", toggleLlamamiento);
      toggleLlamamiento();

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        msg.textContent = "";
        msg.classList.remove("error");

        const data = new FormData(form);

        const first = (data.get("first_name") || "").trim();
        const last = (data.get("last_name") || "").trim();
        const email = (data.get("email") || "").trim();
        const phone = (data.get("phone") || "").trim();
        const barrio = (data.get("barrio") || "").trim();
        const motivo = (data.get("motivo") || "").trim();
        const llamamiento = (data.get("llamamiento") || "").trim();

        if (!first || !last || !email || !phone || !barrio || !motivo) {
          msg.textContent = "Por favor complete todos los campos.";
          msg.classList.add("error");
          return;
        }

        if (
          normalize(motivo) === normalize("Llamamiento / Reporte") &&
          !llamamiento
        ) {
          msg.textContent = "Por favor seleccione su llamamiento.";
          msg.classList.add("error");
          return;
        }

        if (!/^\d{10}$/.test(phone)) {
          msg.textContent =
            "El número de teléfono debe tener 10 números (sin espacios).";
          msg.classList.add("error");
          return;
        }

        if (!email.includes("@")) {
          msg.textContent = 'El correo debe incluir "@".';
          msg.classList.add("error");
          return;
        }

        const targetUrl = URL_BY_MOTIVO[motivo] || DEFAULT_URL;

        const finalUrl = buildUrl(targetUrl, {
          name: first + " " + last,
          email: email,
          a1: "1" + phone,
          a2: barrio,
          a3: motivo,
          a4: llamamiento,
        });

        btn.disabled = true;
        msg.textContent = "Abriendo el calendario…";
        window.location.replace(finalUrl);
      });
    </script>
  </body>
</html>
